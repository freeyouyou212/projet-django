{% extends "base.html" %}
{% block title %}Tableau de bord — Admin{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h1 class="h3 mb-3">Tableau de bord</h1>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card text-bg-light">
      <div class="card-body">
        <h5 class="card-title">Offres reçues</h5>
        <p class="display-6 mb-0">{{ offers_received }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-light">
      <div class="card-body">
        <h5 class="card-title">Offres actives (validées)</h5>
        <p class="display-6 mb-0">{{ offers_active }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-light">
      <div class="card-body">
        <h5 class="card-title">Candidatures totales</h5>
        <p class="display-6 mb-0">{{ applications_submitted }}</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Offres par statut</h5>
        <canvas id="statusChart"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Candidatures par mois (12 derniers mois)</h5>
        <canvas id="applicationsChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">Dernières offres déposées</h5>
    {% if recent_offers %}
      <ul class="list-group list-group-flush">
        {% for offer in recent_offers %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ offer.title }}</strong><br>
              <small class="text-muted">{{ offer.organization }}</small>
            </div>
            <small class="text-muted">
              {{ offer.submission_date|date:"d/m/Y" }} — {{ offer.get_status_display }}
            </small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0">Aucune offre récente.</p>
    {% endif %}
  </div>
</div>

<script>
  // Données pour le graphique "Offres par statut"
  const statusLabels = [
    {% for item in offers_by_status %}
      "{{ item.status }}",
    {% endfor %}
  ];

  const statusData = [
    {% for item in offers_by_status %}
      {{ item.count }},
    {% endfor %}
  ];

  const ctxStatus = document.getElementById('statusChart').getContext('2d');
  new Chart(ctxStatus, {
    type: 'bar',
    data: {
      labels: statusLabels,
      datasets: [{
        label: 'Nombre d\'offres',
        data: statusData,
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          precision: 0
        }
      }
    }
  });

  // Données pour le graphique "Candidatures par mois"
  const monthLabels = [
    {% for item in applications_last_year %}
      "{{ item.month }}",
    {% endfor %}
  ];

  const applicationsData = [
    {% for item in applications_last_year %}
      {{ item.count }},
    {% endfor %}
  ];

  const ctxApps = document.getElementById('applicationsChart').getContext('2d');
  new Chart(ctxApps, {
    type: 'line',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'Candidatures',
        data: applicationsData,
        tension: 0.3,
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          precision: 0
        }
      }
    }
  });
</script>
{% endblock %}
